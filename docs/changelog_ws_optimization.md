# WebSocket 接口优化报告

## 背景
在线上语音识别服务中，原有 WebSocket 实现存在 CPU 100% 占用、缓冲区无限增长以及客户端异常断开时无法清理等问题。主要原因包括：
- 主循环 `while True` 没有任何节流机制，`receive_bytes()` 抛错后立即重试。
- 使用 `np.concatenate` 在每次收到音频时重新复制完整缓冲区，内存和 CPU 消耗随会话时长线性增长。
- 缺乏心跳和 idle 检测，导致僵尸连接持续占用资源。

## 本次改动

### 1. 后端 WebSocket 优化（`server/websocket_handler.py`）
- **环形缓冲**：新增 `AudioBuffer` 类，用 `deque` 存储音频片段，限定最大 6 秒音频，避免巨型数组频繁复制。
- **增量 VAD**：只对新增帧做 VAD，保留窗口余量，防止重复遍历整个缓冲。
- **节流与超时**：`asyncio.wait_for` 设置 2s 接收超时，并在空闲时 `await asyncio.sleep(0.01)`；10s 静默或 3s 未回 `pong` 即通知超时并关闭连接。
- **实时识别窗口**：实时识别仅解码最近 2s 的音频，降低 CPU 高负载。
- **心跳协议**：内建 `ping/pong` 控制消息，配合 `timeout` 通知，让僵尸连接能被及时清理。

### 2. 前端静态页配套（`static/app.js`）
- **心跳与静默检测**：客户端若 5s 内未发送音频，则自动发送 `heartbeat`；收到服务器 `ping` 时立即回应 `pong`。
- **错误提示**：收到 `timeout` 消息时在 UI 中提示“连接空闲超时”，避免用户无感断线。
- **连接管理**：心跳定时器与 `lastAudioSentAt` 结合，确保在不说话阶段也能保持活跃或尽早断开。

### 3. 文档补充（`docs/websocket_connection_changes.md`）
- 对比旧版与新版的连接行为，列出前后端配合方式、心跳/静默策略和推荐阈值，便于前端开发同步。

## 影响
- 长时间无输入的连接会在 10s 后被关闭，用户需要重新发起录音或保持静音帧。
- 服务器在无音频/异常时会主动让出 CPU，整体负载显著下降。
- 需要前端按新协议响应 `ping/pong` 并处理 `timeout` 状态，已有代码已适配。

## 后续建议
- 根据实际通话场景可调 `idle_timeout`、`ping_interval` 等参数。
- 添加集成测试或监控指标（CPU/内存/连接时长），验证优化效果。
